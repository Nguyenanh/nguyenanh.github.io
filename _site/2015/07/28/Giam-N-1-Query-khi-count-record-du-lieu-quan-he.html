<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Giảm N+1 Query khi count record dữ liệu quan hệ &#8211; NguyenAnh Dev Blog</title>
<meta name="description" content="Trong Rails đã hỗ trợ một method includes dùng để hổ trợ việc giảm N+1 query trong truy vấn cơ sở dữ liệu quan hệ. Như vậy ở đây mình đặt ra một bài toán như sau.">
<meta name="keywords" content="count, query n+1, relationship">


<!-- Twitter Cards -->
<meta name="twitter:title" content="Giảm N+1 Query khi count record dữ liệu quan hệ">
<meta name="twitter:description" content="Trong Rails đã hỗ trợ một method includes dùng để hổ trợ việc giảm N+1 query trong truy vấn cơ sở dữ liệu quan hệ. Như vậy ở đây mình đặt ra một bài toán như sau.">



<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/default-thumb.png">

<!-- Open Graph -->
<meta property="og:locale" content="">
<meta property="og:type" content="article">
<meta property="og:title" content="Giảm N+1 Query khi count record dữ liệu quan hệ">
<meta property="og:description" content="Trong Rails đã hỗ trợ một method includes dùng để hổ trợ việc giảm N+1 query trong truy vấn cơ sở dữ liệu quan hệ. Như vậy ở đây mình đặt ra một bài toán như sau.">
<meta property="og:url" content="/2015/07/28/Giam-N-1-Query-khi-count-record-du-lieu-quan-he">
<meta property="og:site_name" content="NguyenAnh Dev Blog">

<meta property="og:image" content="/images/default-thumb.png">






<link rel="canonical" href="/2015/07/28/Giam-N-1-Query-khi-count-record-du-lieu-quan-he">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="NguyenAnh Dev Blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="/assets/js/vendor/html5shiv.min.js"></script>
	<script src="/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="/">NguyenAnh Dev Blog</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav id="site-nav" class="nav">
		    <ul>
		        
				    
				    <li><a href="/about/" >About</a></li>
				
				    
				    <li><a href="/posts/" >All Post</a></li>
				
				    
				    <li><a href="/theme-setup/" >Theme Setup</a></li>
				
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->




<div id="main" role="main">
  <div class="article-author-side">
    

<div itemscope itemtype="http://schema.org/Person">


	<img src="/images/bio-photo.jpeg" class="bio-photo" alt="Nguyen Anh bio photo">


  <h3 itemprop="name">Nguyen Anh</h3>
  <p>A VietNam web developer</p>
  <a href="mailto:cauut2117610@gmail.com" class="author-social" target="_blank"><i class="fa fa-fw fa-envelope-square"></i> Email</a>
  
  <a href="http://facebook.com/anh.nguyen21176" class="author-social" target="_blank"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a>
  
  
  
  
  
  <a href="http://github.com/Nguyenanh" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>
  
  
  
  
  
  
  
  
  
  
  
</div>

  </div>
  <article class="post">
    <div class="headline-wrap">
      
        <h1><a href="/2015/07/28/Giam-N-1-Query-khi-count-record-du-lieu-quan-he" rel="bookmark" title="Giảm N+1 Query khi count record dữ liệu quan hệ">Giảm N+1 Query khi count record dữ liệu quan hệ</a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <p>Trong Rails đã hỗ trợ một method includes dùng để hổ trợ việc giảm N+1 query trong truy vấn cơ sở dữ liệu quan hệ. Như vậy ở đây mình đặt ra một bài toán như sau.
Mình có table <code class="highlighter-rouge">categories</code>  has_many với table <code class="highlighter-rouge">posts</code> và mình muốn lấy list categories và count các bài post tương ứng của category đó thì mình làm như sau:</p>

<p>```ruby
#  Controller
class CategoryController &lt; ApplicationController
  def index
    categories = Category.all
  end
end
# View
&lt;% @categories.each do |category| %&gt;</p>
<h1>&lt;%= category.name %&gt;(&lt;%= category.posts.count %&gt;)<h1>
&lt;% end %&gt;
```
Nhìn vào console bạn sẽ thấy như sau:

&gt;Category Load (0.1ms)  SELECT `categories`.* FROM `categories`
   (0.2ms)  SELECT COUNT(*) FROM `posts` WHERE `posts`.`category_id` = 2
   (0.3ms)  SELECT COUNT(*) FROM `posts` WHERE `posts`.`category_id` = 3
   (0.2ms)  SELECT COUNT(*) FROM `posts` WHERE `posts`.`category_id` = 4

3 câu lệnh SELECT count được thực hiện.  Điều này sẽ ảnh hưởng đến tốc độ truy vấn dữ liệu khi hệ thống dữ liệu lớn. Để giải quyết vấn đề này mình xin hướng dãn 2 cách 
## 1. Tạo một câu query
Mình tạo một cái scope với dòng query như sau:

``` ruby
# Model
class Category &lt; ActiveRecord::Base
  has_many :posts
  scope :with_count_posts, -&gt; {joins(:posts).select("categories.* ,Count(posts.id) AS posts_count").group("categories.id")}
end

# Controller
class CategoryController &lt; ApplicationController
  def index
    @categories = Category.with_count_posts
  end
end

# View
&lt;% @categories.each do |category| %&gt;
  <h1>&lt;%= category.name %&gt;(&lt;%= category.posts_count %&gt;)<h1>
&lt;% end %&gt;
```

Nhìn vào console bạn sẽ thấy sự khác biệt
&gt;Category Load (0.1ms)  SELECT categories.* ,Count(posts.id) AS posts_count FROM `categories` INNER JOIN `posts` ON `posts`.`category_id` = `categories`.`id` GROUP BY categories.id

Nó chỉ cần chạy một truy vấn sơ với ban đầu. Dòng trên có ý nghĩa là khi khi mình lấy hết dữ của bảng categories mình sẽ tạo thêm 1 field là `posts_count` để chứa toàn bộ tổng số những record posts tương ứng với category đó.

------------------------------------------------------------
###  Lưu ý
 `scope` ở trên sẽ không lấy ra những category không có record `posts`  nào. Nếu muốn lấy hết thì bạn có thể tạo một `scope` như dưới đây.
 
``` ruby
  scope :with_count_posts, -&gt; {joins("LEFT JOIN posts ON categories.id = posts.category_id").select("categories.* ,Count(posts.id) AS posts_count").group("categories.id")}
```  
-------------------------------------------------------------

## 2. Dùng `Gem`
Ở đây mình xin giới thiệu 2 `gem` là [includes-count](https://github.com/manastech/includes-count) và [dase](https://github.com/vovayartsev/dase)
Các bạn có thể vào 2 link trên để tìm hiểu cách sử dụng

---------------------------
Trên đây là một bài viết chia sẽ của mình để giảm tốc độ truy vấn khi muốn lấy count record quan hệ. Chúc các bạn thành công.
*Nguyen Anh*
</h1></h1></h1></h1>

      <hr />
      <footer role="contentinfo">
        <div class="social-share">
  <h4>Share on</h4>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=/2015/07/28/Giam-N-1-Query-khi-count-record-du-lieu-quan-he" class="twitter" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=/2015/07/28/Giam-N-1-Query-khi-count-record-du-lieu-quan-he" class="facebook" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=/2015/07/28/Giam-N-1-Query-khi-count-record-du-lieu-quan-he" class="google-plus" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
  </ul>
</div><!-- /.social-share -->
        <p class="byline"><strong>Giảm N+1 Query khi count record dữ liệu quan hệ</strong> was published on <time datetime="2015-07-28T00:00:00-03:00">July 28, 2015</time> and last modified on <time datetime="2015-07-28">July 28, 2015</time>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="/posts/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="/2016/05/01/singleton-pattern-trong-ruby" title="Singleton - Design Pattern trong Ruby">Singleton - Design Pattern trong Ruby</a></li>
    
      <li><a href="/2016/04/13/rails-5-them-loi-canh-bao-khi-quey-du-lieu-lon" title="Thêm lời cảnh báo khi query dữ liêụ lớn trong rails 5">Thêm lời cảnh báo khi query dữ liêụ lớn trong rails 5</a></li>
    
      <li><a href="/2016/04/10/tung-buoc-xay-dung-mot-ruby-gem" title="Từng bước để xây dựng một Ruby Gem">Từng bước để xây dựng một Ruby Gem</a></li>
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  
  <footer>
    

<span>2016 Nguyen Anh.</span>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>


  




</body>
</html>
